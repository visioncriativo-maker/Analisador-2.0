<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analisador v18.5 - Reorder Fix</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

    <style>
        /* --- ESTILO VISUAL (GLASSMORPHISM) --- */
        :root {
            --brand-save: #2563eb;
            --brand-paul: #dc2626;
            --bg-body: #f0f9ff;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            color: #1e293b;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            transition: background 0.5s ease;
        }

        /* Temas */
        body.theme-savegnago { --active-brand: #2563eb; background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); }
        body.theme-paulistao { --active-brand: #dc2626; background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%); }

        /* Card Principal */
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 16px;
            box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.1);
            margin-bottom: 25px;
            overflow: hidden;
            transition: transform 0.2s ease;
        }

        /* Header */
        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            flex-wrap: wrap;
            gap: 20px;
        }

        /* Inputs */
        .input-box {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            font-size: 14px;
            font-family: 'Inter', monospace;
            outline: none;
            transition: all 0.2s;
            background: rgba(255, 255, 255, 0.8);
            box-sizing: border-box;
        }
        .input-box:focus { border-color: var(--active-brand); box-shadow: 0 0 0 4px rgba(37,99,235,0.1); background: white; }

        /* Botões */
        .btn {
            padding: 12px 24px;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
            border: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
            font-size: 0.95rem;
            color: white;
            text-decoration: none;
            position: relative;
            overflow: hidden;
        }
        .btn:hover { transform: translateY(-2px); filter: brightness(1.1); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .btn:active { transform: scale(0.98); }
        
        .btn-primary { background: linear-gradient(135deg, var(--active-brand), #1e40af); }
        body.theme-paulistao .btn-primary { background: linear-gradient(135deg, #dc2626, #991b1b); }
        
        .btn-neutral { background: white; color: #475569; border: 1px solid #e2e8f0; }
        .btn-warning { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .btn-success { background: linear-gradient(135deg, #10b981, #059669); }
        .btn-bug { background: #fee2e2; color: #dc2626; padding: 10px 14px; }

        /* Tabela */
        .table-wrapper { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 900px; }
        th { background: #f8fafc; color: #64748b; font-weight: 800; text-transform: uppercase; font-size: 0.7rem; padding: 16px; text-align: center; border-bottom: 2px solid #e2e8f0; white-space: nowrap; letter-spacing: 0.5px; }
        td { padding: 14px 16px; border-bottom: 1px solid #f1f5f9; font-size: 0.9rem; vertical-align: middle; color: #334155; }
        tr:last-child td { border-bottom: none; }
        tr:hover { background-color: #f8fafc; }

        /* Utilitários */
        .diff-old { text-decoration: line-through; color: #ef4444; font-size: 0.75em; display: block; margin-top: 3px; opacity: 0.7; }
        .price-label { font-size: 0.65rem; text-transform: uppercase; font-weight: 900; display: block; margin-bottom: 4px; opacity: 0.9; letter-spacing: 0.5px; }
        .text-blue { color: #2563eb; }
        .text-pink { color: #db2777; }
        .text-purple { color: #7c3aed; }
        .bg-new { background-color: #f0fdf4 !important; }
        .bg-changed { background-color: #fff7ed !important; }
        .hidden { display: none !important; }
        
        /* Modal & Loader */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 1000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-box { background: white; padding: 30px; border-radius: 20px; width: 90%; max-width: 450px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); animation: zoomIn 0.2s ease; }
        @keyframes zoomIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .spinner { width: 18px; height: 18px; border: 3px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Toast */
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 2000; display: flex; flex-direction: column; gap: 10px; }
        .toast { background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 14px 24px; border-radius: 12px; font-weight: 600; box-shadow: 0 10px 20px -5px rgba(0,0,0,0.2); animation: slideIn 0.3s ease; display: flex; align-items: center; gap: 10px; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
    </style>
</head>

<body class="theme-savegnago">

    <div class="glass-card header-container">
        <div style="display: flex; align-items: center; gap: 15px;">
            <div style="background: #f3e8ff; padding: 12px; border-radius: 14px; box-shadow: 0 4px 6px rgba(126, 34, 206, 0.1);">
                <i class="fa-solid fa-brain" style="font-size: 26px; color: #7e22ce;"></i>
            </div>
            <div>
                <h1 style="margin: 0; font-size: 1.4rem; font-weight: 800; color: #1e293b; letter-spacing: -0.5px;">Analisador v18.5</h1>
                <p style="margin: 0; font-size: 0.75rem; color: #64748b; font-weight: 700; text-transform: uppercase;">Reorder Fix</p>
            </div>
            
            <div style="height: 40px; width: 1px; background: #e2e8f0; margin: 0 10px;"></div>

            <button onclick="toggleCompany()" class="btn btn-neutral" id="companySwitcher">
                <img id="switcherLogo" src="" style="height: 24px; width: auto; margin-right: 8px;">
                <span id="companyLabel" style="font-weight: 800; color: #1e293b; font-size: 1rem;">SAVEGNAGO</span>
                <i class="fa-solid fa-repeat" style="color: #94a3b8; margin-left: 8px;"></i>
            </button>
        </div>

        <div style="display: flex; gap: 10px; align-items: center;">
            <div id="userInfo" class="hidden" style="text-align: right; margin-right: 15px;">
                <div style="font-size: 0.65rem; color: #94a3b8; font-weight: 700; text-transform: uppercase;">Usuário</div>
                <div style="font-weight: 700; color: #334155;" id="userNameDisplay">Visitante</div>
            </div>
            
            <button onclick="generateBugReport()" class="btn btn-bug" title="Reportar Erro"><i class="fa-solid fa-bug"></i></button>
            <button onclick="openConfigModal()" class="btn btn-neutral" title="Configurar"><i class="fa-solid fa-gear"></i></button>
            <button id="authBtn" onclick="toggleAuth()" class="btn btn-primary">Entrar</button>
            <button onclick="openHistory()" class="btn btn-neutral" style="color: #2563eb;"><i class="fa-solid fa-clock-rotate-left"></i></button>
        </div>
    </div>

    <main class="glass-card" style="padding: 30px;">
        <div style="margin-bottom: 25px;">
            <label style="display: block; font-size: 0.75rem; font-weight: 700; color: #64748b; text-transform: uppercase; margin-bottom: 8px;">Nome da Demanda</label>
            <input type="text" id="demandInput" class="input-box" placeholder="Ex: Lâmina FDS...">
        </div>

        <div style="position: relative; margin-bottom: 25px;">
            <textarea id="inputText" class="input-box" style="height: 220px; resize: none; font-size: 13px; line-height: 1.5;" placeholder="Cole a lista aqui..."></textarea>
            <div style="position: absolute; bottom: 12px; right: 12px; font-size: 0.7rem; color: #94a3b8; font-weight: 600; background: white; padding: 4px 8px; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">Texto / JSON</div>
        </div>

        <div class="action-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px;">
            <button id="analyzeBtn" onclick="analyzeWithCohere()" class="btn btn-primary" style="padding: 16px;">
                <i class="fa-solid fa-wand-magic-sparkles"></i> <span id="btnText">Analisar Ofertas</span>
                <div id="loadingSpinner" class="spinner hidden" style="margin-left: 10px;"></div>
            </button>
            <button id="timerButton" class="btn btn-warning">
                <i class="fa-solid fa-stopwatch"></i> <span id="timerButtonText">Iniciar Timer</span>
                <span id="liveTimer" class="hidden" style="margin-left: 10px; background: rgba(255,255,255,0.25); padding: 2px 8px; border-radius: 6px; font-family: monospace;">00:00:00</span>
            </button>
            <button onclick="clearAll()" class="btn btn-neutral" style="color: #ef4444;">
                <i class="fa-solid fa-trash-can"></i> Limpar Tudo
            </button>
        </div>
    </main>

    <div id="summaryPanel" class="glass-card hidden" style="padding: 0;">
        <div style="padding: 15px 30px; border-bottom: 1px solid #e2e8f0; font-weight: 700; color: #334155; background: #f8fafc; display: flex; align-items: center; gap: 10px;">
            <i class="fa-solid fa-chart-simple" style="color: var(--active-brand);"></i> Resumo da Análise
        </div>
        <table style="width: 100%;">
            <tbody id="summaryBody"></tbody>
            <tfoot style="background: #f1f5f9; font-weight: 800; color: var(--active-brand);">
                <tr>
                    <td style="text-align: right; padding-right: 30px;">TOTAL GERAL:</td>
                    <td id="totalCount" style="width: 100px; text-align: center;">0</td>
                </tr>
            </tfoot>
        </table>
    </div>

    <div id="resultsArea"></div>

    <footer style="text-align: center; padding: 40px; font-size: 0.75rem; color: #94a3b8;">
        <p style="margin-bottom: 5px; font-weight: 600;">Desenvolvido por Rendrix e Luan</p>
        <p>v18.5 - Reorder Fix</p>
    </footer>

    <div id="configModal" class="modal-overlay">
        <div class="modal-box">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                <h2 style="margin: 0; color: #1e293b; font-size: 1.4rem; font-weight: 800;">Configurar IA</h2>
                <i class="fa-solid fa-xmark" style="cursor: pointer; color: #94a3b8; font-size: 1.2rem;" onclick="closeConfigModal()"></i>
            </div>
            <div style="margin-bottom: 20px;">
                <label style="font-size: 0.75rem; font-weight: 700; color: #64748b; display: block; margin-bottom: 8px;">MODELO</label>
                <select id="modelSelect" class="input-box">
                    <option value="command">command (Padrão)</option>
                    <option value="command-light">command-light (Rápido)</option>
                    <option value="command-nightly">command-nightly (Beta)</option>
                </select>
            </div>
            <div style="margin-bottom: 30px;">
                <label style="font-size: 0.75rem; font-weight: 700; color: #64748b; display: block; margin-bottom: 8px;">API KEY</label>
                <input type="password" id="apiKeyInput" class="input-box" placeholder="Cole sua chave aqui...">
            </div>
            <button onclick="saveApiKey()" class="btn btn-primary" style="width: 100%;">Salvar Configurações</button>
        </div>
    </div>
    
    <div id="loginModal" class="modal-overlay">
        <div class="modal-box" style="text-align: center;">
             <h2 style="margin: 0; color: #1e293b; font-size: 1.5rem; font-weight: 800;">Identifique-se</h2>
             <p style="color: #64748b; font-size: 0.9rem; margin-bottom: 25px; margin-top: 5px;">Para salvar seu histórico de uso</p>
             <input type="text" id="userInput" class="input-box" placeholder="Seu Nome" style="text-align: center; font-weight: bold; margin-bottom: 25px; font-size: 1.1rem;">
             <button onclick="login()" class="btn btn-primary" style="width: 100%;">Entrar no Sistema</button>
        </div>
    </div>
    
    <div id="historyModal" class="modal-overlay">
        <div class="modal-box" style="max-width: 900px; width: 95%;">
             <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #f1f5f9;">
                <h2 style="margin: 0; color: #1e293b; font-size: 1.4rem; font-weight: 800;">Histórico</h2>
                <i class="fa-solid fa-xmark" style="cursor: pointer; font-size: 1.2rem; color: #94a3b8;" onclick="toggleModal('historyModal', false)"></i>
             </div>
             <div style="max-height: 60vh; overflow-y: auto;">
                 <table>
                     <thead><tr><th>Data</th><th>Rede</th><th>Demanda</th><th>Usuário</th><th>Tempo</th></tr></thead>
                     <tbody id="historyBody"></tbody>
                 </table>
             </div>
             <button onclick="clearHistory()" style="margin-top: 20px; color: #ef4444; background: none; border: none; cursor: pointer; text-decoration: underline; font-size: 0.85rem; font-weight: 600;">Limpar Histórico Completo</button>
        </div>
    </div>

    <div id="toast-container"></div>

    <script>
        // --- LÓGICA DO SISTEMA ---
        
        // Configurações
        const CITIES_SAVEGNAGO = ["Americana", "Araraquara", "Araras", "Barretos", "Bebedouro", "Campinas", "Franca", "Hortolândia", "Indaiatuba", "Jaboticabal", "Jardinópolis", "Leme", "Limeira", "Matão", "Monte Alto", "Piracicaba", "Ribeirão Preto", "Rio Claro", "São Carlos", "Sertãozinho", "Sumaré"];
        const CITIES_PAULISTAO = ["Araraquara", "Barretos", "Campinas", "Franca", "Ribeirão Preto", "Santa Bárbara", "Rio Claro", "Sertãozinho"];
        const LOGO_SAVEGNAGO = "https://savegnagoio.vtexassets.com/assets/vtex/assets-builder/savegnagoio.store-theme/14.0.36/home/logo-save___ee8753fa9fd1e21018b817a0d020549f.png";
        const LOGO_PAULISTAO = "https://paulistaoatacadista.vtexassets.com/assets/vtex.file-manager-graphql/images/91d1697e-7efa-471e-b763-68b8b71430b2___db630f93263bf9ecc924c4493e2279f9.png";
        
        window.systemLogs = []; window.lastRawResponse = ""; window.lastParsedData = null;
        function logSystem(m, t='INFO') { window.systemLogs.push(`[${new Date().toLocaleTimeString()}] [${t}] ${m}`); if(t==='ERROR') console.error(m); else console.log(m); }
        
        let API_KEY = localStorage.getItem('cohere_api_key');
        let SELECTED_MODEL = localStorage.getItem('cohere_model') || 'command';
        let CURRENT_COMPANY = localStorage.getItem('company') || 'SAVEGNAGO';
        let MASTER_CITIES = (CURRENT_COMPANY === 'SAVEGNAGO') ? CITIES_SAVEGNAGO : CITIES_PAULISTAO;
        let CURRENT_USER = localStorage.getItem('user');
        window.parsedData = [];

        // Inicialização
        applyTheme(); updateUserUI();
        if (!API_KEY) setTimeout(openConfigModal, 500);
        document.getElementById('modelSelect').value = SELECTED_MODEL;

        // --- SANITIZADOR DE JSON ---
        function extractJSON(str) {
            const firstOpen = str.indexOf('[');
            const lastClose = str.lastIndexOf(']');
            if (firstOpen !== -1 && lastClose !== -1) {
                return str.substring(firstOpen, lastClose + 1);
            }
            const firstObj = str.indexOf('{');
            const lastObj = str.lastIndexOf('}');
            if (firstObj !== -1 && lastObj !== -1) {
                return "[" + str.substring(firstObj, lastObj + 1) + "]";
            }
            throw new Error("Dados inválidos. A IA não retornou uma lista compreensível.");
        }

        // --- FORMATADORES DE TEXTO ---
        function toTitleCase(str) {
            if(!str) return "";
            const smallWords = /^(de|da|do|das|dos|e|em|na|no|nas|nos|com|por|para|o|a|os|as|um|uma|que|como|pelo|pela|ao|aos|ou)$/i;
            return str.toLowerCase().split(' ').map((word, index) => {
                const cleanWord = word.replace(/[^\w\u00C0-\u00FF]/g, '');
                if (index > 0 && smallWords.test(cleanWord)) return word;
                return word.charAt(0).toUpperCase() + word.slice(1);
            }).join(' ');
        }
        
        function formatCityList(cities) {
            if (!cities || cities.length === 0) return "Nenhuma cidade identificada";
            if (cities.length === 1) return cities[0];
            const copy = [...cities]; const last = copy.pop(); return copy.join(', ') + ' e ' + last; 
        }

        // --- LÓGICA DE NEGÓCIO ---
        function toggleCompany() {
            CURRENT_COMPANY = (CURRENT_COMPANY === 'SAVEGNAGO') ? 'PAULISTAO' : 'SAVEGNAGO';
            localStorage.setItem('company', CURRENT_COMPANY);
            MASTER_CITIES = (CURRENT_COMPANY === 'SAVEGNAGO') ? CITIES_SAVEGNAGO : CITIES_PAULISTAO;
            applyTheme();
            if (window.parsedData.length) { processCitiesLogic(window.parsedData); renderAllTables(); }
        }

        function applyTheme() {
            const body = document.body;
            const logo = document.getElementById('switcherLogo');
            const label = document.getElementById('companyLabel');
            if (CURRENT_COMPANY === 'SAVEGNAGO') {
                body.className = 'theme-savegnago';
                label.textContent = "SAVEGNAGO";
                logo.src = LOGO_SAVEGNAGO;
            } else {
                body.className = 'theme-paulistao';
                label.textContent = "PAULISTÃO";
                logo.src = LOGO_PAULISTAO;
            }
        }

        async function analyzeWithCohere() {
            const text = document.getElementById('inputText').value;
            if (!API_KEY) { openConfigModal(); return; }
            if (!text.trim()) { showToast("Cole o texto!", "error"); return; }
            
            const btn = document.getElementById('analyzeBtn'); 
            const spinner = document.getElementById('loadingSpinner'); 
            const btnText = document.getElementById('btnText');
            
            btn.disabled = true; btnText.textContent = "Processando..."; spinner.classList.remove('hidden');
            document.getElementById('resultsArea').innerHTML = ''; 
            document.getElementById('summaryPanel').classList.add('hidden');
            
            // PROMPT 
            const prompt = `Você é um especialista em extração de dados JSON.
            
            REGRAS CRÍTICAS:
            1. MULTI-SKU: Capture TODOS os códigos (ex: 123/456) separados por barra.
            2. ATACADO/REGRAS: Tudo o que não for nome ou preço normal deve ir para "atacado". Ex: "A partir de X unid", "Nesta embalagem a unidade sai...", "Limite de...". Capture frases entre parênteses abaixo do preço também.
            3. PREÇO: Se vazio, use "0,00".
            4. Retorne APENAS o JSON puro (Array de objetos), sem texto antes ou depois.
            5. DESCONTO: Se houver texto como "XX% de desconto", mova para o campo "desconto" e tire da descrição.

            JSON ESPERADO: 
            [{"header": "Nome Lista", "itens": [{"desc": "Nome", "preco": "X,XX", "cod": "123/456", "clube": "X,XX", "nome_clube": "Save/Cartão", "atacado": "Texto completo das regras", "desconto": "20%"}]}]
            
            TEXTO: ${text}`;
            
            try {
                const response = await fetch("https://api.cohere.ai/v1/chat", {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${API_KEY}`, "Content-Type": "application/json" },
                    body: JSON.stringify({ model: SELECTED_MODEL, message: prompt, temperature: 0.1 })
                });
                const data = await response.json();
                if (data.message) throw new Error(data.message);
                
                window.lastRawResponse = data.text;
                const jsonStr = extractJSON(data.text);
                let rawData = JSON.parse(jsonStr);
                if (!Array.isArray(rawData)) rawData = [rawData];

                rawData.forEach(lista => {
                    lista.itens.forEach(item => {
                        item.desc = toTitleCase(item.desc);
                        if (!item.preco || item.preco === "null") item.preco = "0,00";
                    });
                });
                
                processCitiesLogic(rawData);
                window.parsedData = rawData;
                renderSummary(); renderAllTables(); showToast("Sucesso!");
            } catch (e) { 
                alert("Erro: " + e.message); 
                logSystem(e.message, 'ERROR'); 
            }
            finally { 
                btn.disabled = false; btnText.textContent = "Analisar Ofertas"; spinner.classList.add('hidden'); 
            }
        }

        function processCitiesLogic(data) {
            let specificCities = [];
            for (let i = 1; i < data.length; i++) {
                const header = (data[i].header || "").toUpperCase();
                data[i].cityList = [];
                MASTER_CITIES.forEach(city => {
                    const normHeader = header.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                    const normCity = city.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase();
                    if (normHeader.includes(normCity)) {
                        let final = city === "Santa Bárbara" ? "Santa Bárbara d'Oeste" : city;
                        data[i].cityList.push(final);
                        specificCities.push(city);
                    }
                });
            }
            if (data.length > 0) {
                data[0].cityList = MASTER_CITIES.filter(c => !specificCities.includes(c));
                if (!data[0].header || data[0].header.toUpperCase().includes("GERAL") || data[0].header.toUpperCase().includes("VALIDAS")) data[0].header = "LISTA GERAL (REDE)";
            }
        }

        function renderSummary() {
            const tbody = document.getElementById('summaryBody'); tbody.innerHTML = ''; let total = 0;
            window.parsedData.forEach(l => {
                total += l.itens.length;
                tbody.innerHTML += `<tr><td style="font-weight: 600;">${l.header} <span style="font-size: 0.7rem; background: #e2e8f0; padding: 2px 6px; border-radius: 4px; color: #64748b; margin-left: 5px;">${l.cityList ? l.cityList.length : 0} CIDADES</span></td><td style="text-align: center; font-weight: 800; color: var(--active-brand);">${l.itens.length}</td></tr>`;
            });
            document.getElementById('totalCount').textContent = total;
            document.getElementById('summaryPanel').classList.remove('hidden');
        }

        function renderAllTables() {
            const container = document.getElementById('resultsArea'); container.innerHTML = '';
            const listaGeral = window.parsedData[0];
            window.parsedData.forEach((lista, idx) => {
                const wrapper = document.createElement('div'); wrapper.className = "glass-card";
                const citiesText = formatCityList(lista.cityList);
                const isAuto = idx === 0 ? '<span style="font-size: 0.65rem; background: #e0e7ff; color: #4338ca; padding: 3px 8px; border-radius: 6px; border: 1px solid #c7d2fe; margin-right: 8px; font-weight: 700;">AUTOMÁTICO</span>' : '';
                
                const header = `
                    <div style="padding: 20px 30px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                        <div>
                            <h3 style="margin: 0; font-size: 1.2rem; color: #1e293b; display: flex; align-items: center; font-weight: 800;">${isAuto} ${lista.header}</h3>
                            <div style="display: flex; align-items: center; gap: 6px; margin-top: 6px;">
                                <i class="fa-solid fa-map-pin" style="color: #ef4444; font-size: 0.9rem;"></i>
                                <span style="font-size: 0.85rem; color: #64748b; font-weight: 500;">${citiesText}</span>
                                <button onclick="copyToClip('${citiesText.replace(/'/g, "\\'")}')" style="background: none; border: none; cursor: pointer; color: #94a3b8; padding: 2px;"><i class="fa-regular fa-copy"></i></button>
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            ${idx === 0 ? `<button onclick="reorder(${idx})" class="btn btn-warning" style="font-size: 0.8rem; padding: 8px 16px;"><i class="fa-solid fa-arrow-down-short-wide"></i> Reordenar</button>` : ''}
                            <button onclick="copyList(${idx}, this)" class="btn btn-success" style="font-size: 0.8rem; padding: 8px 16px;"><i class="fa-regular fa-copy"></i> Copiar</button>
                            <button onclick="exportXLS(${idx})" class="btn btn-primary" style="font-size: 0.8rem; padding: 8px 16px;"><i class="fa-solid fa-file-excel"></i> Excel</button>
                        </div>
                    </div>`;

                let rows = ''; 
                const labelClubText = CURRENT_COMPANY === 'SAVEGNAGO' ? 'SAVE GANHE' : 'CLIENTE CAMPEÃO';

                lista.itens.forEach((item, i) => {
                    let showRow = true;
                    let descDisplay = item.desc;
                    let priceDisplay = `R$ ${item.preco}`;
                    let cardDisplay = (item.nome_clube && item.nome_clube.toLowerCase().includes('cartão')) ? `<span class="price-label text-blue">NOSSO CARTÃO</span>R$ ${item.clube}` : '-';
                    let clubDisplay = (item.nome_clube && !item.nome_clube.toLowerCase().includes('cartão') && item.clube) ? `<span class="price-label text-pink">${labelClubText}</span>R$ ${item.clube}` : '-';
                    let atacadoDisplay = item.atacado ? `<span class="price-label text-purple">ATACADO / REGRAS</span>${item.atacado}` : '-';
                    let rowStyle = "";

                    if (idx > 0 && listaGeral) {
                        let refItem = null;
                        if(item.cod) {
                            const codes = item.cod.toString().replace(/red\./gi, '').split(/[\/,\s]+/).filter(c=>c.trim()!=='');
                            refItem = listaGeral.itens.find(r => {
                                if(!r.cod) return false;
                                const rCodes = r.cod.toString().replace(/red\./gi, '').split(/[\/,\s]+/).filter(c=>c.trim()!=='');
                                return codes.some(c => rCodes.includes(c));
                            });
                        } else {
                            refItem = listaGeral.itens.find(r => r.desc.trim() === item.desc.trim());
                        }

                        if(refItem) {
                            const isSame = (item.preco.trim() === refItem.preco.trim()) &&
                                           (item.desc.trim() === refItem.desc.trim()) &&
                                           ((item.atacado||'').trim() === (refItem.atacado||'').trim());

                            if(isSame) showRow = false;
                            else {
                                rowStyle = "background-color: #fefce8;"; // Yellow
                                if(item.desc.trim() !== refItem.desc.trim()) {
                                    descDisplay += ` <span style="font-size: 0.6rem; background: #ffedd5; color: #c2410c; padding: 2px 5px; border-radius: 4px; font-weight: 700;">ALTERADO</span>`;
                                    descDisplay += `<span class="diff-old">Era: ${refItem.desc}</span>`;
                                }
                                if(item.preco !== refItem.preco) priceDisplay += `<span class="diff-old">Era: ${refItem.preco}</span>`;
                            }
                        } else {
                            descDisplay = `<span class="diff-new" style="color: #15803d; font-weight: 700;">${item.desc}</span> <span style="font-size: 0.6rem; background: #dcfce7; color: #15803d; padding: 2px 5px; border-radius: 4px; font-weight: 700;">NOVO</span>`;
                            rowStyle = "background-color: #f0fdf4;"; // Green
                        }
                    }

                    if(showRow) {
                        const orderCell = idx === 0 ? `<input type="number" class="order-input" style="padding: 5px; text-align: center; width: 50px;" value="${i + 1}">` : `<span style="color: #94a3b8; font-weight: 700; font-size: 0.75rem;">${i + 1}</span>`;
                        const baseUrl = CURRENT_COMPANY === 'SAVEGNAGO' ? 'https://www.savegnago.com.br/' : 'https://www.paulistaoatacadista.com.br/';
                        
                        let linkHtml = '<span style="color: #cbd5e1;">-</span>';
                        if(item.cod) {
                            const codes = item.cod.toString().replace(/red\./gi, '').split(/[\/,\s]+/);
                            linkHtml = '<div style="display: flex; flex-direction: column; gap: 4px; align-items: center;">';
                            codes.forEach(c => {
                                let clean = c.replace(/[^0-9]/g, '');
                                if(clean) linkHtml += `<div style="background: #f8fafc; padding: 2px 6px; border-radius: 4px; border: 1px solid #e2e8f0; display: flex; align-items: center; gap: 4px;"><a href="${baseUrl}${clean}" target="_blank" class="sku-link" style="background: none; padding: 0; font-size: 0.7rem; text-decoration: none; color: var(--active-brand); font-weight: 700;">${clean} <i class="fa-solid fa-arrow-up-right-from-square" style="font-size: 8px; opacity: 0.5;"></i></a><i class="fa-regular fa-copy" style="cursor: pointer; font-size: 0.7rem; color: #94a3b8;" onclick="animateCopyBtn(this, '${clean}')"></i></div>`;
                            });
                            linkHtml += '</div>';
                        }
                        
                        const nameBtn = `<i class="fa-regular fa-copy" style="cursor: pointer; color: #94a3b8; margin-left: 8px;" onclick="copyAndStrike(this, '${item.desc.replace(/'/g, "\\'")}')"></i>`;

                        rows += `<tr style="${rowStyle}" id="table-${idx}-row-${i}">
                            <td style="text-align: center;"><input type="checkbox" onchange="this.closest('tr').style.backgroundColor = this.checked ? '#f0fdf4' : ''"></td>
                            <td style="text-align: center;">${orderCell}</td>
                            <td style="text-align: center;">${linkHtml}</td>
                            <td><div style="display: flex; justify-content: space-between; align-items: center; font-weight: 600; font-size: 0.85rem; color: #334155;"><span>${descDisplay}</span>${nameBtn}</div></td>
                            <td style="text-align: center; font-weight: 800; color: #1e293b;">${priceDisplay}</td>
                            <td style="text-align: center; font-size: 0.8rem;">${cardDisplay}</td>
                            <td style="text-align: center; font-size: 0.8rem;">${clubDisplay}</td>
                            <td style="text-align: center; font-size: 0.75rem; color: #6d28d9; max-width: 250px; line-height: 1.3;">${atacadoDisplay}</td>
                        </tr>`;
                    }
                });
                
                if(rows === '') rows = `<tr><td colspan="8" style="padding: 30px; text-align: center; color: #94a3b8; font-style: italic;">Nenhuma alteração encontrada.</td></tr>`;

                wrapper.innerHTML = `${header}<div class="table-wrapper"><table id="table-${idx}"><thead><tr>
                    <th style="width: 40px; text-align: center;"><i class="fa-solid fa-check"></i></th>
                    <th style="width: 50px; text-align: center;">#</th>
                    <th style="text-align: center;">Cód</th>
                    <th style="min-width: 250px; text-align: left;">Descrição</th>
                    <th style="text-align: center;">Normal</th>
                    <th style="text-align: center;">Cartão</th>
                    <th style="text-align: center;">${labelClubText}</th>
                    <th style="text-align: center; min-width: 150px;">Atacado / Regras</th>
                </tr></thead><tbody>${rows}</tbody></table></div>`;
                container.appendChild(wrapper);
            });
        }

        // --- UTILS ---
        function animateCopyBtn(el, text) { navigator.clipboard.writeText(text); const o=el.className; el.className="fa-solid fa-check"; el.style.color="#16a34a"; setTimeout(()=>{el.className="fa-regular fa-copy"; el.style.color="#94a3b8";},1500); showToast("Copiado!"); }
        function copyAndStrike(el, text) { navigator.clipboard.writeText(text); const span = el.previousElementSibling; if(span) span.style.textDecoration = "line-through"; span.style.opacity = "0.5"; animateCopyBtn(el, text); }
        function copyToClip(text) { navigator.clipboard.writeText(text); showToast("Copiado!"); }
        function showToast(m,t="success"){ const d=document.createElement("div"); d.className=`toast ${t}`; d.innerHTML=`<i class="fa-solid fa-check-circle"></i> ${m}`; document.getElementById("toast-container").appendChild(d); setTimeout(()=>d.remove(),3000); }
        
        function copyList(idx, btn) {
            const list = window.parsedData[idx];
            let text = "";
            
            // Re-select rows to respect current visual order
            const table = document.getElementById(`table-${idx}`);
            if(!table) return;
            
            const rows = table.querySelectorAll('tbody tr');
            
            rows.forEach((row) => {
                // Find item index from original list logic if needed, or parse from DOM
                // Better approach: Use the data directly if reorder updates it, 
                // BUT reorder updates 'list.itens'. So we can iterate list.itens
                
                // Let's use the 'list.itens' which is updated by reorder()
            });
            
            // Since reorder updates window.parsedData[idx].itens, we can iterate that
            list.itens.forEach((item, i) => {
                text += `${i + 1} - ${item.desc} – R$ ${item.preco}\n`;
            });
            
            navigator.clipboard.writeText(text).then(() => showToast("Lista Copiada!"));
        }

        function reorder(idx) {
            const table = document.getElementById(`table-${idx}`);
            const rows = table.querySelectorAll('tbody tr');
            const map = new Map();
            
            rows.forEach((row, i) => {
                const input = row.querySelector('.order-input');
                const val = input ? input.value : null;
                // We need to know which original item this row corresponds to. 
                // The easiest way is to trust the current order if no ID is present, 
                // BUT 'i' is the current index.
                
                // V18.5 Fix: map visual index 'i' to new order value 'val'
                // The 'list.itens' array is currently in the visual order (if previously reordered) 
                // or original order. 
                
                map.set(i, val ? parseInt(val) : 9999);
            });

            const list = window.parsedData[idx];
            
            // Create a temp array combining item and its new sort value
            const temp = list.itens.map((item, i) => ({ 
                item, 
                val: map.get(i), 
                oldIdx: i 
            }));
            
            // Sort
            temp.sort((a, b) => (a.val - b.val) || (a.oldIdx - b.oldIdx));
            
            // Update main data
            list.itens = temp.map(t => t.item);
            
            renderAllTables();
            showToast("Reordenado!");
        }

        function exportXLS(idx) { const list=window.parsedData[idx]; const ws=XLSX.utils.json_to_sheet(list.itens); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Ofertas"); XLSX.writeFile(wb, `Lista_${idx}.xlsx`); }
        function clearAll() { document.getElementById("inputText").value=""; document.getElementById("resultsArea").innerHTML=""; document.getElementById("summaryPanel").classList.add("hidden"); window.parsedData=[]; }
        
        function generateBugReport() {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.text("Relatório de Debug", 10, 10);
                doc.text(`Data: ${new Date().toLocaleString()}`, 10, 20);
                doc.text("Resposta Bruta:", 10, 30);
                const splitText = doc.splitTextToSize(window.lastRawResponse || "Vazio", 180);
                doc.text(splitText, 10, 40);
                doc.save("BugReport.pdf");
            } catch(e) { alert("Erro ao gerar PDF"); }
        }

        // Modais
        function openConfigModal() { document.getElementById("configModal").style.display = "flex"; }
        function closeConfigModal() { document.getElementById("configModal").style.display = "none"; }
        function saveApiKey() { localStorage.setItem("cohere_api_key", document.getElementById("apiKeyInput").value); API_KEY = document.getElementById("apiKeyInput").value; closeConfigModal(); }
        function toggleAuth() { if(CURRENT_USER) { if(confirm("Sair?")) { localStorage.removeItem("user"); CURRENT_USER=null; updateUserUI(); } } else { document.getElementById("loginModal").style.display="flex"; } }
        function login() { const n = document.getElementById("userInput").value; if(n) { CURRENT_USER=n; localStorage.setItem("user", n); updateUserUI(); document.getElementById("loginModal").style.display="none"; } }
        function updateUserUI() { const b=document.getElementById("authBtn"); const u=document.getElementById("userInfo"); if(CURRENT_USER) { b.textContent="Sair"; u.classList.remove("hidden"); document.getElementById("userNameDisplay").textContent=CURRENT_USER; } else { b.textContent="Entrar"; u.classList.add("hidden"); } }
        function openHistory() { document.getElementById("historyModal").style.display = "flex"; }
        function toggleModal(id, show) { document.getElementById(id).style.display = show ? "flex" : "none"; }
        function clearHistory() { if(confirm("Apagar?")) { localStorage.removeItem('appHistory'); openHistory(); } }
    </script>
</body>

</html>
