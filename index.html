<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analisador v21.0 - Enterprise Grade</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root { --brand-primary: #2563eb; --bg-app: #f8fafc; }
        body.theme-savegnago { --brand-primary: #2563eb; --bg-grad: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); }
        body.theme-paulistao { --brand-primary: #dc2626; --bg-grad: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%); }
        
        body { font-family: 'Inter', sans-serif; background: var(--bg-grad); color: #1e293b; min-height: 100vh; padding: 20px; }
        
        .card { background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.6); border-radius: 16px; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); margin-bottom: 20px; overflow: hidden; }
        
        .btn { display: inline-flex; align-items: center; justify-content: center; padding: 10px 20px; border-radius: 8px; font-weight: 600; transition: all 0.2s; cursor: pointer; gap: 8px; border: none; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--brand-primary); color: white; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .btn-primary:hover { filter: brightness(1.1); }
        .btn-neutral { background: white; border: 1px solid #cbd5e1; color: #475569; }
        .btn-danger { background: #fee2e2; color: #dc2626; }
        .btn-warning { background: #f59e0b; color: white; }
        
        .input-std { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; outline: none; transition: 0.2s; }
        .input-std:focus { border-color: var(--brand-primary); box-shadow: 0 0 0 3px rgba(0,0,0,0.05); }
        
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th { background: #f1f5f9; padding: 12px; text-align: center; font-weight: 700; color: #64748b; border-bottom: 2px solid #e2e8f0; }
        td { padding: 10px; border-bottom: 1px solid #f1f5f9; vertical-align: middle; }
        tr:hover { background: #f8fafc; }
        
        .spinner { width: 20px; height: 20px; border: 3px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 50; backdrop-filter: blur(4px); }
        .modal-content { background: white; padding: 25px; border-radius: 16px; width: 90%; max-width: 500px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); animation: slideUp 0.3s ease; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        #toast-box { position: fixed; bottom: 20px; right: 20px; z-index: 100; display: flex; flex-direction: column; gap: 10px; }
        .toast { background: #10b981; color: white; padding: 12px 20px; border-radius: 8px; font-weight: 600; box-shadow: 0 5px 15px rgba(0,0,0,0.1); animation: fadeIn 0.3s; }
        .toast.error { background: #ef4444; }
        @keyframes fadeIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        
        .hidden { display: none !important; }
    </style>
</head>

<body class="theme-savegnago">

    <div class="card" style="padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
        <div style="display: flex; align-items: center; gap: 15px;">
            <div style="background: #f3e8ff; padding: 10px; border-radius: 10px;"><i class="fa-solid fa-shield-halved" style="font-size: 24px; color: #7e22ce;"></i></div>
            <div>
                <h1 style="margin: 0; font-size: 1.3rem; font-weight: 800;">Analisador v21.0</h1>
                <p style="margin: 0; font-size: 0.75rem; color: #64748b; font-weight: 700; text-transform: uppercase;">Enterprise Stability</p>
            </div>
        </div>
        
        <div style="display: flex; gap: 10px; align-items: center;">
            <button onclick="toggleCompany()" class="btn btn-neutral" id="companyBtn">
                <span id="companyName">SAVEGNAGO</span> <i class="fa-solid fa-repeat"></i>
            </button>
            <button onclick="openConfig()" class="btn btn-neutral"><i class="fa-solid fa-gear"></i></button>
            <button onclick="generateReport()" class="btn btn-danger" title="Reportar Bug"><i class="fa-solid fa-bug"></i></button>
        </div>
    </div>

    <div class="card" style="padding: 25px;">
        <div style="margin-bottom: 20px;">
            <label style="font-size: 0.75rem; font-weight: 700; color: #64748b; text-transform: uppercase; display: block; margin-bottom: 5px;">Título da Demanda</label>
            <input type="text" id="demandInput" class="input-std" placeholder="Ex: Lâmina FDS...">
        </div>
        
        <div style="position: relative; margin-bottom: 20px;">
            <textarea id="inputText" class="input-std" style="height: 200px; resize: none; font-family: monospace;" placeholder="Cole a lista de produtos aqui..."></textarea>
            <div style="position: absolute; bottom: 10px; right: 10px; font-size: 0.7rem; background: #e2e8f0; padding: 2px 6px; border-radius: 4px; font-weight: 600; color: #475569;">TEXTO BRUTO</div>
        </div>

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
            <button id="analyzeBtn" onclick="runAnalysis()" class="btn btn-primary" style="padding: 15px;">
                <i class="fa-solid fa-bolt"></i> <span id="btnText">Processar Lista</span>
                <div id="spinner" class="spinner hidden"></div>
            </button>
            <button id="timerBtn" onclick="toggleTimer()" class="btn btn-warning">
                <i class="fa-solid fa-stopwatch"></i> <span id="timerText">Iniciar Timer</span>
                <span id="timerDisplay" class="hidden" style="margin-left: 10px; background: rgba(0,0,0,0.2); padding: 2px 6px; border-radius: 4px; font-family: monospace;">00:00:00</span>
            </button>
            <button onclick="clearAll()" class="btn btn-neutral" style="color: #ef4444;"><i class="fa-solid fa-trash"></i> Limpar</button>
        </div>
    </div>

    <div id="resultsArea"></div>

    <div style="text-align: center; margin-top: 40px; color: #94a3b8; font-size: 0.8rem;">
        <p>Desenvolvido por Rendrix e Luan | v21.0 Stable</p>
        <button onclick="hardReset()" style="background: none; border: none; text-decoration: underline; color: #ef4444; cursor: pointer; margin-top: 5px;">Resetar Configurações (Fábrica)</button>
    </div>

    <div id="modalConfig" class="modal">
        <div class="modal-content">
            <h2 style="margin-top: 0; margin-bottom: 20px; font-weight: 800;">Configurações</h2>
            <label style="display: block; font-size: 0.75rem; font-weight: 700; color: #64748b; margin-bottom: 5px;">API KEY</label>
            <input type="password" id="apiKey" class="input-std" style="margin-bottom: 20px;">
            
            <label style="display: block; font-size: 0.75rem; font-weight: 700; color: #64748b; margin-bottom: 5px;">MODELO (Auto-Gerenciado)</label>
            <select id="modelSelect" class="input-std" style="margin-bottom: 20px; background: #f1f5f9;">
                <option value="command-r-plus-08-2024">command-r-plus-08-2024 (Recomendado)</option>
                <option value="command-r-08-2024">command-r-08-2024 (Rápido)</option>
            </select>
            
            <div style="display: flex; gap: 10px;">
                <button onclick="saveConfig()" class="btn btn-primary" style="flex: 1;">Salvar</button>
                <button onclick="closeModal('modalConfig')" class="btn btn-neutral">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="modalFix" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <h2 style="margin-top: 0; color: #dc2626; font-weight: 800;"><i class="fa-solid fa-triangle-exclamation"></i> Atenção</h2>
            <p style="color: #475569; margin-bottom: 15px;">A IA retornou dados incompletos ou inválidos. Tente corrigir o JSON abaixo manualmente ou tente processar novamente.</p>
            <textarea id="manualJsonInput" class="input-std" style="height: 300px; font-family: monospace; font-size: 0.8rem; background: #fff1f2; border-color: #fda4af;"></textarea>
            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button onclick="processManualJson()" class="btn btn-primary">Processar Correção</button>
                <button onclick="closeModal('modalFix')" class="btn btn-neutral">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="toast-box"></div>

    <script>
        // --- CORE CONFIG ---
        const CONFIG = {
            citiesSave: ["Americana", "Araraquara", "Araras", "Barretos", "Bebedouro", "Campinas", "Franca", "Hortolândia", "Indaiatuba", "Jaboticabal", "Jardinópolis", "Leme", "Limeira", "Matão", "Monte Alto", "Piracicaba", "Ribeirão Preto", "Rio Claro", "São Carlos", "Sertãozinho", "Sumaré"],
            citiesPaul: ["Araraquara", "Barretos", "Campinas", "Franca", "Ribeirão Preto", "Santa Bárbara", "Rio Claro", "Sertãozinho", "Mogi"],
            corrections: { "muçarela": "Mussarela", "mussarela": "Mussarela", "pateko": "Patéko", "páteko": "Patéko", "contra filé": "Contrafilé", "contra-filé": "Contrafilé", "pêra": "Pera", "1l": "1L", "2l": "2L", "3l": "3L", "5l": "5L", "10l": "10L", "1,5l": "1,5L", "tub": "Tubo", "tubo": "Tubo", "mms": "M&Ms", "kilo": "kg", "sbp": "SBP", "off": "OFF", "on": "ON" }
        };

        let STATE = {
            company: localStorage.getItem('app_company') || 'SAVEGNAGO',
            apiKey: localStorage.getItem('cohere_api_key') || '',
            model: 'command-r-plus-08-2024', // HARDCODED DEFAULT
            timer: null,
            timerStart: null,
            lastRaw: ''
        };

        // --- INIT & AUTO-REPAIR ---
        (function init() {
            // Force reset old models
            const savedModel = localStorage.getItem('cohere_model');
            if (!savedModel || savedModel.includes('command-nightly') || savedModel === 'command') {
                localStorage.setItem('cohere_model', STATE.model);
            } else {
                STATE.model = savedModel;
            }
            
            applyTheme();
            document.getElementById('apiKey').value = STATE.apiKey;
            document.getElementById('modelSelect').value = STATE.model;
            
            if(!STATE.apiKey) openConfig();
        })();

        // --- SAFE DOM HELPERS ---
        function el(id) { return document.getElementById(id); }
        function show(id) { if(el(id)) el(id).classList.remove('hidden'); }
        function hide(id) { if(el(id)) el(id).classList.add('hidden'); }
        function toast(msg, type='success') {
            const t = document.createElement('div');
            t.className = `toast ${type}`; t.innerHTML = msg;
            el('toast-box').appendChild(t);
            setTimeout(() => t.remove(), 4000);
        }

        // --- LOGIC ---
        async function runAnalysis() {
            const text = el('demandInput').value + "\n" + el('inputText').value;
            if(!STATE.apiKey) return openConfig();
            if(el('inputText').value.length < 5) return toast("Cole a lista primeiro!", "error");

            setLoading(true);
            
            try {
                const prompt = `Extraia dados JSON.
                REGRAS: 
                1. CLUBE: 'Save Ganhe', 'Nosso Cartão' etc vão para 'clube'.
                2. ATACADO: Apenas regras de qtd (Leve 3...). SEM SKUS.
                3. MULTI-SKU: Capture todos os codigos.
                4. FORMATAÇÃO: '1l' -> '1L', 'kg' minusculo.
                5. SAÍDA: Apenas JSON puro.
                
                Modelo: [{"header": "Nome", "itens": [{"desc": "Nome", "preco": "0,00", "cod": "123", "clube": "0,00", "nome_clube": "Save", "atacado": "Regras", "desconto": "20%"}]}]
                
                Texto: ${el('inputText').value}`;

                const response = await fetch("https://api.cohere.ai/v1/chat", {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${STATE.apiKey}`, "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: STATE.model,
                        message: prompt,
                        temperature: 0.0,
                        max_tokens: 4000
                    })
                });

                const data = await response.json();
                
                if(data.message) {
                    if(data.message.includes('removed')) {
                        // Auto-fix model error
                        localStorage.setItem('cohere_model', 'command-r-plus-08-2024');
                        STATE.model = 'command-r-plus-08-2024';
                        throw new Error("Modelo atualizado. Tente novamente.");
                    }
                    throw new Error(data.message);
                }

                STATE.lastRaw = data.text;
                const json = robustJSONParse(data.text);
                renderResults(json);
                toast("Processado com sucesso!");

            } catch (e) {
                console.error(e);
                // Fail-safe mode
                el('manualJsonInput').value = STATE.lastRaw;
                openModal('modalFix');
                toast("Erro na leitura automática. Tente corrigir manual.", "error");
            } finally {
                setLoading(false);
            }
        }

        // --- ROBUST PARSER (The Magic) ---
        function robustJSONParse(str) {
            // 1. Clean markdown
            let clean = str.replace(/```json/g, '').replace(/```/g, '').trim();
            
            // 2. Extract strictly between first [ and last ]
            const start = clean.indexOf('[');
            const end = clean.lastIndexOf(']');
            
            if(start === -1 || end === -1) throw new Error("JSON markers not found");
            
            let jsonStr = clean.substring(start, end + 1);
            
            // 3. Try parsing
            try {
                return JSON.parse(jsonStr);
            } catch (e) {
                // 4. Auto-repair simple errors (like missing quotes on keys)
                // This is risky but helps in edge cases. For now, let's just fail to manual mode.
                throw new Error("JSON Syntax Error");
            }
        }

        function processManualJson() {
            try {
                const json = robustJSONParse(el('manualJsonInput').value);
                renderResults(json);
                closeModal('modalFix');
                toast("Corrigido e Processado!");
            } catch(e) {
                toast("Ainda há erro no JSON: " + e.message, "error");
            }
        }

        // --- RENDERING ---
        function renderResults(data) {
            if(!Array.isArray(data)) data = [data];
            const container = el('resultsArea');
            container.innerHTML = '';

            data.forEach((lista, idx) => {
                // City Logic
                let cities = [];
                const masterCities = STATE.company === 'SAVEGNAGO' ? CONFIG.citiesSave : CONFIG.citiesPaul;
                const headerNorm = (lista.header || '').normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase();
                
                masterCities.forEach(city => {
                    const cityNorm = city.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase();
                    if(headerNorm.includes(cityNorm)) {
                        let finalName = city;
                        if(city === 'Santa Bárbara') finalName = "Santa Bárbara d'Oeste";
                        if(city === 'Mogi') finalName = "Mogi Guaçu";
                        if(!cities.includes(finalName)) cities.push(finalName);
                    }
                });
                
                // Cluster logic
                const hasCamp = cities.some(c => c.includes('Campinas'));
                const hasSB = cities.some(c => c.includes('Santa Bárbara'));
                if((hasCamp || hasSB) && !cities.includes('Mogi Guaçu')) cities.push('Mogi Guaçu');

                const cityStr = cities.length ? cities.join(', ') : "Geral (Rede)";

                // HTML Build
                const card = document.createElement('div');
                card.className = 'card';
                
                let rows = '';
                if(lista.itens) {
                    lista.itens.forEach((item, i) => {
                        // Data cleaning
                        item.desc = cleanText(item.desc);
                        item.atacado = cleanAtacado(item.atacado, item); // Pass item to move club prices
                        if(!item.preco) item.preco = "0,00";

                        rows += `
                        <tr>
                            <td><input type="number" class="input-std" style="width:50px; text-align:center; padding:5px;" value="${i+1}"></td>
                            <td>${item.cod || '-'}</td>
                            <td style="text-align: left;">${item.desc}</td>
                            <td><b>${item.preco}</b></td>
                            <td>${item.nome_clube && item.nome_clube.toLowerCase().includes('cartão') ? item.clube : '-'}</td>
                            <td>${item.nome_clube && !item.nome_clube.toLowerCase().includes('cartão') && item.clube ? item.clube : '-'}</td>
                            <td style="color: #7e22ce; font-size:0.8rem;">${item.atacado || '-'}</td>
                        </tr>`;
                    });
                }

                card.innerHTML = `
                    <div style="padding: 15px 25px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h3 style="margin:0; font-weight:800;">${lista.header || 'Lista'}</h3>
                            <div style="font-size:0.8rem; color:#64748b; margin-top:5px;"><i class="fa-solid fa-map-pin"></i> ${cityStr}</div>
                        </div>
                        <div>
                            <button class="btn btn-primary" onclick="copyList(this)"><i class="fa-regular fa-copy"></i> Copiar</button>
                        </div>
                    </div>
                    <div style="overflow-x:auto;">
                        <table>
                            <thead><tr><th>#</th><th>Cód</th><th style="text-align:left;">Descrição</th><th>Preço</th><th>Cartão</th><th>Clube</th><th>Atacado</th></tr></thead>
                            <tbody>${rows}</tbody>
                        </table>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // --- CLEANERS ---
        function cleanText(str) {
            if(!str) return "";
            let s = str;
            // Litros regex
            s = s.replace(/(\d)l\b/gi, '$1L');
            s = s.replace(/\s+kilo\s+/gi, " kg ");
            
            // Dictionary
            for(let key in CONFIG.corrections) {
                let reg = new RegExp(`\\b${key}\\b`, 'gi');
                if(key.match(/\d/)) s = s.replace(new RegExp(key, 'gi'), CONFIG.corrections[key]);
                else s = s.replace(reg, CONFIG.corrections[key]);
            }
            
            // Title Case
            const minor = /^(de|da|do|e|em|na|no|com|por|para|o|a|os|as|um|uma)$/i;
            return s.split(' ').map((w,i) => {
                if(Object.values(CONFIG.corrections).includes(w)) return w;
                if(/\d+L$/.test(w)) return w;
                if(i>0 && minor.test(w)) return w.toLowerCase();
                return w.charAt(0).toUpperCase() + w.slice(1).toLowerCase();
            }).join(' ');
        }

        function cleanAtacado(text, itemRef) {
            if(!text) return "";
            let s = text;
            
            // Move club prices if found in atacado
            const priceMatch = s.match(/R\$\s*(\d+,\d{2})/);
            const lower = s.toLowerCase();
            if(lower.includes('ganhe') || lower.includes('cartão') || lower.includes('campeão')) {
                if(priceMatch && (!itemRef.clube || itemRef.clube === '0,00')) {
                    itemRef.clube = priceMatch[1];
                    itemRef.nome_clube = lower.includes('cartão') ? "Nosso Cartão" : "Clube";
                }
                // Nuke the text
                s = s.replace(/(save|ganhe|cliente|campeão|nosso|cartão).*?(R\$\s*\d+,\d{2})?/gi, "");
            }
            
            // Remove SKUs
            s = s.replace(/red\.?\s*[\d\/]+/gi, "").replace(/\(?\d{4,}\)?/g, "");
            
            return s.replace(/^[\s,\.-]+|[\s,\.-]+$/g, "").trim();
        }

        // --- UTILS ---
        function setLoading(active) {
            const btn = el('analyzeBtn');
            const spin = el('spinner');
            const txt = el('btnText');
            if(active) {
                if(btn) btn.disabled = true;
                if(spin) spin.classList.remove('hidden');
                if(txt) txt.textContent = "Processando...";
            } else {
                if(btn) btn.disabled = false;
                if(spin) spin.classList.add('hidden');
                if(txt) txt.textContent = "Processar Lista";
            }
        }

        function toggleTimer() {
            const btn = el('timerBtn');
            const display = el('timerDisplay');
            const txt = el('timerText');
            
            if(STATE.timer) {
                clearInterval(STATE.timer);
                STATE.timer = null;
                btn.classList.remove('btn-warning');
                btn.classList.add('btn-primary'); // Change color to indicate stop
                if(txt) txt.textContent = "Continuar";
                // Don't hide display
            } else {
                STATE.timerStart = STATE.timerStart || new Date(); // Resume or start
                btn.classList.add('btn-warning');
                btn.classList.remove('btn-primary');
                if(txt) txt.textContent = "Parar";
                if(display) display.classList.remove('hidden');
                
                STATE.timer = setInterval(() => {
                    const now = new Date();
                    const diff = new Date(now - STATE.timerStart);
                    display.textContent = diff.toISOString().substr(11, 8);
                }, 1000);
            }
        }

        function toggleCompany() {
            STATE.company = STATE.company === 'SAVEGNAGO' ? 'PAULISTAO' : 'SAVEGNAGO';
            localStorage.setItem('app_company', STATE.company);
            applyTheme();
        }

        function applyTheme() {
            document.body.className = STATE.company === 'SAVEGNAGO' ? 'theme-savegnago' : 'theme-paulistao';
            if(el('companyName')) el('companyName').textContent = STATE.company;
        }

        function clearAll() {
            el('inputText').value = '';
            el('resultsArea').innerHTML = '';
            el('demandInput').value = '';
        }

        function hardReset() {
            if(confirm("Isso apagará sua Chave API e configurações. Continuar?")) {
                localStorage.clear();
                location.reload();
            }
        }

        function openConfig() { show('modalConfig'); }
        function closeModal(id) { hide(id); }
        function openModal(id) { show(id); }
        
        function saveConfig() {
            const key = el('apiKey').value;
            const model = el('modelSelect').value;
            if(!key) return toast("Cole sua API Key", "error");
            localStorage.setItem('cohere_api_key', key);
            localStorage.setItem('cohere_model', model);
            STATE.apiKey = key;
            STATE.model = model;
            closeModal('modalConfig');
            toast("Salvo!");
        }
        
        function generateReport() {
             try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                let y = 10;
                doc.text("Relatório de Debug", 10, y); y+=10;
                doc.setFontSize(10);
                doc.text(STATE.lastRaw || "Sem dados.", 10, y, {maxWidth: 190});
                doc.save("Debug.pdf");
             } catch(e) { alert("Erro PDF"); }
        }
        
        // Copy helper logic needs to traverse DOM from button
        window.copyList = function(btn) {
            const card = btn.closest('.card');
            const rows = card.querySelectorAll('tbody tr');
            let text = "";
            rows.forEach(tr => {
               const cols = tr.querySelectorAll('td');
               text += `${cols[0].querySelector('input').value} - ${cols[2].textContent} – ${cols[3].textContent}\n`;
            });
            navigator.clipboard.writeText(text);
            toast("Copiado!");
        }

    </script>
</body>
</html>
